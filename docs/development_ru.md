# LPCandy - Api документация

# API

## POST /api/entity-edit

**Описание:** Используется для создания и редактирования сущностей. Позволяет передавать любое кол-во параметров для сущности, в том числе позволяет загружать файлы.

**Параметры:**

**Обязательные:**

type - Тип сущности

**Опциональные:**

id - ID сущности

**Ограничения:** 

public_read - ограничение на доступ к публичному чтению данных о сущности, 
public_edit - ограничение на доступ к публичному редактированию сущности, 
public_create - ограничение на публичное редактирование сущности, 
upload - ограничение на доступ к загрузке файлов 

**Пример запроса на создание сущности:**

```jsx
{
	// обязательные поля
	"type": "project",
	// кастомные поля
	"title": "Project title",
	"thumb": "upload/image.png" 
}
```

**Пример запроса на редактирование сущности:**

```jsx
{
	// обязательные поля
	"id": 123
	"type": "project",
	// кастомные поля, что нужно отредактировать
	"title": "New Project title"
}
```

**Ответы:**

**Пустой ответ:**

- Сущность не найдена
- Указанный тип в запросе не совпадает с типом найденной сущности
- Тип сущности не указан
- Конфиг для сущности не задан
- Сущность не публичная и пользователь не создатель
- Сущность публичная, но есть ограничение на редактирование
- В случае создания новой сущности, если есть ограничение на создание

**Сущность найдена, пример ответа:**

```jsx
{
	// обязательные поля
	"id": 1908,
	"ip": "119.129.12.34",
	"created": 1592409057,
	"page_id": false,
	"page_title": false,
	"files": [],
	// Кастомные поля отдельно взятой сущности
	"status": "active",
	"text": "Text example"
}
```

- Сущность публична и доступна для чтения
- Сущность не публична и пользователь это создатель сущности

**Ответ по умолчанию:**

```jsx
{ id: 123 }
```

---

## POST /api/entity-list

**Описание:** Используется для получения списка сущностей указанного типа.

**Параметры:**

**Обязательные:**

type - тип сущности

**Опциональные:**

id - массив id сущностей,
perPage - кол-во элементов на странице, 
sortBy - поле по которому производится сортировка, 
sortOrder - порядок сортировки (DESC, ASC), 
p - номер страницы

**Ограничения:** Требует авторизации пользователя. 

**Фильтрация:**

Фильтрация может производится как и по стандартным полям, которые доступны для всех сущностей, так и по полям которые относятся к отдельно взятой сущности.

Поля которые всегда доступны для фильтрации: **id, ip, page, created**

**Пример запроса:**

```jsx
{
	"type": "project",
	"id[]": 1905,
	"id[]": 1906,
	"sortOrder": "DESC",
	"status": "active"
}
```

**Ответы:**

**Пустой ответ:**

- Не указан тип сущности

**Пример удачного ответа:**

```jsx
{
	list: [
		{
			// обязательные поля
			"id": 1908,
			"ip": "119.129.12.34",
			"created": 1592409057,
			"page_id": false,
			"page_title": false,
			"files": [],
			// Кастомные поля отдельно взятой сущности
			"status": "active",
			"text": "Text example"
		}
	],
	pageCount: 10,
	pageNumber: 2
}
```

---

## POST /api/entity-delete

**Описание:** Удаляет сущность по id

**Параметры**: 

id - идентификатор сущности

**Ограничения:** Пользователь должен быть создателем сущности

**Ответы:**

Пустой ответ:

- Сущность не найдена
- Пользователь не создатель сущности

Удачное удаление: **true**

---

## GET /api/entity-file

**Описание:** Используется для скачивания файлов сущности

**Параметры:**

**Обязательные:**

id - ID сущности,
name - Имя файла

**Ограничения:**

- Сущность должна быть доступна для чтения

---

## POST /api/upload

**Описание:** Используется для загрузки файлов

**Параметры:**

**Обязательные:**

name - имя директории

**Ограничения:** 

- Требует авторизации пользователя
- Ограничение на размер файла

**Пример запроса:**

```jsx
{
	"file-0": (binary),
	"name": "files"
}
```

**Ответы:**

**Пустой ответ:**

- Не указано имя директории
- Имя указано в неверном формате (строка вместит в себе "..")

**Ошибки:**

- File is too large. Maximum upload size is 30
- No file was uploaded
- Upload error. Try again later

**Удачная загрузка:**

```jsx
[
	{
		"name":"bird(17).png",
		"url":"/upload/LPCandy/files/184/files/filename.png"
	}
]
```

---

## POST /api/email-send

**Описание:** Используется для отправки сообщений на почту

**Параметры:**

**Обязательные:**

subject - Тема сообщения,
text - Текст сообщения, возможна отправка HTML

**Ограничения:** Требует авторизации пользователя.

**Пример запроса:**

```jsx
{
	"subject": "LPCandy: у вас есть новая заявка",
	"text": "Текст сообщения"
}
```

**Ответы:**

**Удачная отправка**: true

**Ошибка отправки**: false

---

# Введение в разработку компонентов

### **Bergamot**

Используется для сборки проекта. Ссылка на документацию - [https://github.com/boomyjee/bergamot](https://github.com/boomyjee/bergamot)

**Основные команды:**

`bergamot watch` - для отслеживания изменений в файлах

`bergamot build` - для сборки проекта

`bergamot minify` - для сборки и минификации проекта 

### **Стили**

Для написание стилей используется teacss. Ссылка на документацию - ([http://teacss.org/](http://teacss.org/)) 

### Пример структуры компонента

![LPCandy%20Api%2068555cc6289146cdbeaa8649c977e719/Untitled.png](LPCandy%20Api%2068555cc6289146cdbeaa8649c977e719/Untitled.png)

**index.js** - Входная точка вашего компонента. 

**ru.js** - Файл с переводами

**components** - Директория со всеми компонентами

**lib** - Директория с библиотеками

---

# Создание блока

Для создания нового блока нужно выполнить  несколько простых шагов, которые мало чем отличаются от привычного написания React компонентов. 
Начинается разработка из создания самого компонента блока, который наследуется от внутреннего компонента Block и переопределяет его стандартные методы.

**Ниже приведена стандартная структура компонента блока:**

```jsx
class Custom extends Block { 
    
    static get title() { return _t('Title') }
    static get description() { return _t('Description') }

    tpl_1(val) {
        return html``
    }

    tpl_default_1() {
        return { name: "name" }
    }
}
```

**Описание методов:**

- title - Заголовок блока
- description - Описание блока
- tpl_default_1 - Данные по умолчанию, которые можно изменить в редакторе
- tpl_val(val) - Аналог render метода в React, val - это аргумент который хранит в себе редактируемые пользователем данные

**Регистрация блока**

Для отображения и дальнейшего использования/тестирования компонента в редакторе, его нужно зарегистрировать. Для этого в файле с вашим компонентом нужно добавить следующий код:

```jsx
Block.register('Custom',exports = Custom);
```

После чего созданный вами компонент будет доступен в диалоговом окне добавления блока в редакторе

---

# Регистрация сущности

В случае необходимости создания новой сущности, ее необходимо зарегистрировать используя следующий код:

```jsx
Entity.register('<entity_name>',class extends Entity {
    static get menuLabel() { return _t('Menu Item') }
    static get label() { return  _t('My <entity>') }
    static get labelMultiple() { return _t('My <entities>') }
    static get listComponent() { return EntityList }
    static get formComponent() { return EntityForm }
});
```

**menuLabel** 

Описание: Текст для ссылки в меню

**label** 

Описание: Заголовок страницы

**labelMultiple** 

Описание: Заголовок страницы в множественном числе

**listComponent**

Описание: Компонент страницы в панели администратора для вывода, фильтрации и удаления сущностей. Компонент должен расширять внутренний компонент EntityList, который и позволяет выполнять все выше перечисленные действия.

**formComponent**

Описание: Компонент страницы в панели администратора для создания, редактирования сущностей. Он должен расширять внутренний компонент EntityForm.

**Далее нужно прописать параметры доступа к вашей сущности в файле config.php:**

```php
'entityTypes' => [
      'project' => [
          'public_create' => true,
          'public_edit' => false,
          'public_read' => false,
          'upload' => true
      ],
  ]
```

После выполнения данных настроек, сущность будет доступна для взаимодействия с использованием API

---

# Компиляция и подключение компонента

Для того чтобы ваш компонент был доступен внутри lpcandy, во входной точке вашего компонента, вам необходимо подключать файлы внутри конструкции, которая предоставлена ниже.

```jsx
window.lpcandyRun(()=>{
	window._t.load(require("ru.js"));
	// Ваши компоненты, регистрации сущностей
});
```

Для того чтобы собрать ваш компонент необходимо в файле bergamot.config.js добавить дополнительную входную точку и путь компиляции: 

```jsx
module.exports = {
    lpcandy: {
        entry_point: "front/site/index.js",
        bundle_path: "public/assets/lpcandy.min.js",
        js_transform
    },
    <your_key>: {
        entry_point: "front/extra/<your_key>/index.js",
        bundle_path: "public/assets/extra/<your_key>.min.js",
        js_transform
    }
}
```

После чего, для сборки вашего компонента, необходимо выполнить команду:

```sql
bergamot build lpcandy <your_key>
```